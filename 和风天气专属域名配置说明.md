# 和风天气专属域名配置说明

## 🔍 问题根源

根据错误信息和API文档，和风天气API已经更新，**必须使用专属API域名**，不能再使用通用的 `geoapi.qweather.com` 和 `devapi.qweather.com`。

这就是为什么会出现：
- **404错误** - 通用域名已不再支持
- **403错误 - Invalid Host** - API服务器拒绝来自通用域名的请求

## ✅ 解决方案

### 步骤1：获取专属API域名

1. **登录和风天气控制台**
   - 访问 [和风天气控制台](https://console.qweather.com/)
   - 使用你的账号登录

2. **查看专属域名**
   - 进入你的项目（项目ID：`2K85XYGFMK`）
   - 在项目设置或API配置中查找 **"专属域名"** 或 **"API域名"**
   - 专属域名格式通常类似：`https://[你的专属域名].qweather.com`
   - 或者：`https://api.qweather.com`（如果已配置）

3. **如果没有专属域名**
   - 可能需要升级套餐或联系和风天气客服
   - 或者检查是否有其他配置选项

### 步骤2：更新代码配置

获取专属域名后，需要更新以下文件：

#### 2.1 更新 `miniprogram/utils/config.ts`

在配置中添加专属域名：

```typescript
weather: {
  // ... 其他配置
  qweatherKey: '5157c47b70ae4e2ca6517bb8ec621512',
  // 添加专属域名配置
  qweatherDomain: 'https://你的专属域名.qweather.com', // 或 'https://api.qweather.com'
  // ... 其他配置
}
```

#### 2.2 更新 `miniprogram/utils/features/weather.ts`

将所有API地址从通用域名改为使用配置的专属域名：

**需要修改的地方：**
1. `getCityLocationId` 函数中的城市查询API
2. `loadWeather` 函数中的当前天气API
3. `loadWeather` 函数中的空气质量API
4. `loadWeatherForecast` 函数中的天气预报API
5. `weather.ts` 页面中的 `resolveCityName` 函数

---

## 🔧 临时解决方案（如果无法获取专属域名）

如果暂时无法获取专属域名，可以尝试：

### 方案A：使用和风天气的备用域名

根据和风天气文档，可以尝试使用：
- `https://api.qweather.com`（如果支持）
- 或者联系和风天气技术支持获取临时解决方案

### 方案B：使用服务器代理（推荐生产环境）

1. 搭建一个服务器代理
2. 在服务器端调用和风天气API
3. 小程序通过代理服务器获取数据

这样可以：
- 保护API Key
- 避免域名限制问题
- 更好的控制和缓存

---

## 📝 具体修改步骤

### 修改1：更新 config.ts

```typescript
weather: {
  apiProxy: '',
  qweatherKey: '5157c47b70ae4e2ca6517bb8ec621512',
  // 新增：专属域名配置
  qweatherDomain: 'https://你的专属域名.qweather.com', // 需要从控制台获取
  amapKey: '',
  useMockData: false,
  directCall: true,
}
```

### 修改2：更新 weather.ts 中的API地址

将所有：
- `https://geoapi.qweather.com` → `${CONFIG.weather.qweatherDomain}/geo`
- `https://devapi.qweather.com` → `${CONFIG.weather.qweatherDomain}`

---

## ⚠️ 重要提示

1. **专属域名是必需的**
   - 和风天气已不再支持通用域名
   - 必须使用专属域名才能正常调用API

2. **域名配置**
   - 获取专属域名后，也需要在微信小程序后台配置该域名
   - 添加到 request合法域名列表

3. **API版本**
   - 确认使用的API版本（v2/v7）是否支持你的套餐
   - 某些功能可能需要付费套餐

---

## 🎯 下一步操作

1. **立即操作：**
   - ✅ 登录和风天气控制台
   - ✅ 查找并获取专属API域名
   - ✅ 告诉我专属域名，我会帮你更新代码

2. **或者：**
   - ✅ 如果控制台没有显示专属域名
   - ✅ 联系和风天气技术支持：support@qweather.com
   - ✅ 说明你在微信小程序中使用API遇到403/404错误

---

**创建日期：** 2025-01-13  
**问题类型：** 和风天气API专属域名配置  
**相关文件：** `miniprogram/utils/config.ts`, `miniprogram/utils/features/weather.ts`
