# å¤©æ°”åŠŸèƒ½æ•°æ®åº“æ£€æŸ¥è¯´æ˜

## ğŸ” é—®é¢˜åˆ†æ

ä»ä»£ç æ£€æŸ¥æ¥çœ‹ï¼Œå¤©æ°”åŠŸèƒ½å¯èƒ½å­˜åœ¨çš„æ•°æ®åº“é—®é¢˜ï¼š

1. **RLSç­–ç•¥é—®é¢˜** - `weather_settings` è¡¨çš„è¡Œçº§å®‰å…¨ç­–ç•¥å¯èƒ½æœªæ­£ç¡®é…ç½®
2. **å¸ƒå°”å€¼è¿‡æ»¤é—®é¢˜** - ä»£ç ä¸­å·²ä¿®å¤ï¼Œä½†éœ€è¦ç¡®è®¤æ•°æ®åº“ç­–ç•¥

## âœ… éœ€è¦ä½ æ‰§è¡Œçš„æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥å¹¶ä¿®å¤RLSç­–ç•¥ï¼ˆé‡è¦ï¼‰

**åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹SQLï¼š**

```sql
-- æ–‡ä»¶ä½ç½®ï¼šdatabase/fix_weather_settings_rls.sql
-- æ‰§è¡Œæ­¤æ–‡ä»¶ä¸­çš„æ‰€æœ‰SQLè¯­å¥
```

æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œï¼š

```sql
-- 1. ç¡®ä¿ RLS å·²å¯ç”¨
ALTER TABLE weather_settings ENABLE ROW LEVEL SECURITY;

-- 2. åˆ é™¤æ—§ç­–ç•¥
DROP POLICY IF EXISTS "Allow anonymous read" ON weather_settings;
DROP POLICY IF EXISTS "Allow anonymous insert" ON weather_settings;
DROP POLICY IF EXISTS "Allow anonymous update" ON weather_settings;
DROP POLICY IF EXISTS "Allow anonymous delete" ON weather_settings;

-- 3. é‡æ–°åˆ›å»ºç­–ç•¥
CREATE POLICY "Allow anonymous read" ON weather_settings FOR SELECT USING (true);
CREATE POLICY "Allow anonymous insert" ON weather_settings FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow anonymous update" ON weather_settings FOR UPDATE USING (true);
CREATE POLICY "Allow anonymous delete" ON weather_settings FOR DELETE USING (true);

-- 4. éªŒè¯ç­–ç•¥
SELECT schemaname, tablename, policyname, permissive, roles, cmd 
FROM pg_policies 
WHERE tablename = 'weather_settings'
ORDER BY policyname;
```

**é¢„æœŸç»“æœï¼š** åº”è¯¥çœ‹åˆ°4æ¡ç­–ç•¥ï¼ˆSELECT, INSERT, UPDATE, DELETEï¼‰

### æ­¥éª¤2ï¼šéªŒè¯æ•°æ®åº“è¡¨ç»“æ„

ç¡®è®¤ `weather_settings` è¡¨æœ‰ä»¥ä¸‹å­—æ®µï¼š
- `id` (VARCHAR, PRIMARY KEY)
- `user_id` (VARCHAR, DEFAULT 'default_user')
- `city_name` (VARCHAR, NOT NULL)
- `city_code` (VARCHAR, å¯ä¸ºç©º)
- `is_default` (BOOLEAN, DEFAULT FALSE)
- `created_at` (TIMESTAMP)

## ğŸ”§ ä»£ç ä¿®å¤

æˆ‘å·²ç»ä¿®å¤äº†ä»£ç ä¸­çš„å¸ƒå°”å€¼è¿‡æ»¤é—®é¢˜ï¼š
- `filter: { is_default: true }` â†’ `filter: { is_default: 'true' }`
- Supabase PostgREST API éœ€è¦å°†å¸ƒå°”å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œè¿‡æ»¤

## ğŸ“Š æµ‹è¯•æ¸…å•

æ‰§è¡ŒSQLåï¼Œè¯·æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š

- [ ] æ‰“å¼€å¤©æ°”é¡µé¢ï¼ŒæŸ¥çœ‹æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤ºå¤©æ°”æ•°æ®
- [ ] ç‚¹å‡»"æ·»åŠ åŸå¸‚"æŒ‰é’®ï¼Œæµ‹è¯•æ·»åŠ åŸå¸‚åŠŸèƒ½
- [ ] æµ‹è¯•è®¾ç½®é»˜è®¤åŸå¸‚åŠŸèƒ½
- [ ] æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰401é”™è¯¯
- [ ] æ£€æŸ¥åŸå¸‚åˆ—è¡¨æ˜¯å¦èƒ½æ­£å¸¸ä¿å­˜å’ŒåŠ è½½

## âš ï¸ å¦‚æœè¿˜æœ‰é—®é¢˜

å¦‚æœæ‰§è¡ŒSQLåä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **æ§åˆ¶å°é”™è¯¯ä¿¡æ¯**
   - æ˜¯å¦æœ‰401 Unauthorizedé”™è¯¯ï¼Ÿ
   - æ˜¯å¦æœ‰å…¶ä»–æ•°æ®åº“ç›¸å…³é”™è¯¯ï¼Ÿ

2. **ç½‘ç»œè¯·æ±‚**
   - æ‰“å¼€Networké¢æ¿
   - æŸ¥æ‰¾å¯¹ `weather_settings` çš„è¯·æ±‚
   - æ£€æŸ¥çŠ¶æ€ç ï¼ˆåº”è¯¥æ˜¯200ï¼Œä¸æ˜¯401ï¼‰

3. **æ•°æ®åº“æ•°æ®**
   - åœ¨Supabaseæ§åˆ¶å°æŸ¥çœ‹ `weather_settings` è¡¨
   - ç¡®è®¤æ˜¯å¦æœ‰æ•°æ®
   - ç¡®è®¤å­—æ®µåæ˜¯å¦æ­£ç¡®

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-01-13  
**ä¿®å¤æ–‡ä»¶ï¼š** `miniprogram/utils/db/weather.ts`
