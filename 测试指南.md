# 校园生活小程序测试指南

## 一、准备工作

### 1. 配置微信小程序网络请求域名

在微信小程序后台配置 Supabase API 域名：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入你的小程序后台
3. 开发 → 开发管理 → 开发设置
4. 找到「服务器域名」→「request合法域名」
5. 添加域名：`https://mvzpegvtiafzzznzvdqx.supabase.co`
6. 保存配置（可能需要等待几分钟生效）

### 2. 确认 Supabase 数据库已创建

1. 登录 [Supabase 控制台](https://supabase.com/dashboard)
2. 进入你的项目：`mvzpegvtiafzzznzvdqx`
3. 打开 SQL Editor
4. 确认已执行 `database/schema.sql` 中的所有 SQL 语句
5. 检查表是否都已创建：
   - `user_profiles`
   - `anniversaries`
   - `moments`
   - `moment_comments`
   - `notes`
   - `habit_records`
   - `saving_records`
   - `courses`

### 3. 打开微信开发者工具

1. 打开微信开发者工具
2. 导入项目，选择项目目录：`D:\aer\wenjian`
3. 填写 AppID（如果没有，选择测试号）
4. 点击「编译」按钮

## 二、功能测试清单

### ✅ 1. 首页模块测试

**测试步骤：**
1. 启动小程序，查看首页是否正常显示
2. 检查问候语是否根据时间段变化
3. 检查日期显示是否正确
4. 检查纪念日倒计时卡片是否显示
5. 点击各个功能按钮，是否能正常跳转

**预期结果：**
- 页面正常加载，无报错
- 问候语、日期显示正确
- 纪念日数据从数据库加载（如果数据库为空，显示默认状态）
- 功能按钮跳转正常

**检查点：**
- 打开调试器，查看 Console 是否有错误
- 查看 Network 面板，确认是否有请求发送到 Supabase

### ✅ 2. 动态模块测试

**测试步骤：**
1. 进入「动态」页面
2. 查看动态列表是否从数据库加载
3. 点击「发布」按钮
4. 填写动态内容，选择图片（可选），填写位置（可选）
5. 点击「发布」按钮
6. 返回动态列表，查看新发布的动态是否显示
7. 测试点赞功能
8. 测试评论功能
9. 下拉刷新，查看是否能重新加载数据

**预期结果：**
- 动态列表正常显示（可能为空，这是正常的）
- 发布动态成功，显示在列表顶部
- 点赞功能正常，数据保存到数据库
- 评论功能正常，评论保存到数据库
- 下拉刷新能重新加载最新数据

**数据库验证：**
- 在 Supabase 控制台查看 `moments` 表，确认数据已保存
- 查看 `moment_comments` 表，确认评论已保存

### ✅ 3. 笔记模块测试

**测试步骤：**
1. 进入「记事本」页面
2. 点击「+」按钮创建新笔记
3. 输入笔记内容，添加图片（可选）
4. 返回列表，查看笔记是否保存
5. 点击笔记卡片，编辑笔记内容
6. 长按笔记卡片，测试置顶功能
7. 长按笔记卡片，测试删除功能
8. 测试搜索功能

**预期结果：**
- 笔记列表正常显示
- 创建笔记成功，保存到数据库
- 编辑笔记成功，更新数据库
- 置顶功能正常
- 删除功能正常
- 搜索功能正常

**数据库验证：**
- 在 Supabase 控制台查看 `notes` 表，确认数据已保存

### ✅ 4. 纪念日模块测试

**测试步骤：**
1. 进入「纪念日」页面
2. 点击「+」按钮添加新纪念日
3. 填写事件名称、选择目标日期
4. 设置是否置顶、重复类型
5. 保存后返回列表，查看是否显示
6. 点击纪念日卡片，编辑纪念日
7. 测试删除功能
8. 返回首页，查看纪念日倒计时是否更新

**预期结果：**
- 纪念日列表正常显示
- 添加纪念日成功，保存到数据库
- 编辑纪念日成功，更新数据库
- 删除功能正常
- 首页倒计时正确显示

**数据库验证：**
- 在 Supabase 控制台查看 `anniversaries` 表，确认数据已保存

### ✅ 5. 打卡模块测试

**测试步骤：**
1. 进入「打卡」页面
2. 查看今日打卡任务是否显示
3. 点击「每日签到」任务，完成签到
4. 点击「随机任务」，发布包含关键词的动态
5. 查看任务完成状态和进度
6. 下拉刷新，查看数据是否从数据库加载

**预期结果：**
- 打卡任务正常显示
- 签到功能正常，数据保存到数据库
- 随机任务验证正常
- 进度计算正确

**数据库验证：**
- 在 Supabase 控制台查看 `habit_records` 表，确认数据已保存

### ✅ 6. 存钱罐模块测试

**测试步骤：**
1. 进入「存钱罐」页面
2. 查看当前余额（初始为 0）
3. 点击「存钱」按钮，输入金额，确认存入
4. 查看余额是否更新
5. 点击「取钱」按钮，输入金额，确认取出
6. 查看余额是否正确计算
7. 点击「查看记录」，查看交易历史

**预期结果：**
- 余额显示正确
- 存钱功能正常，数据保存到数据库
- 取钱功能正常，数据保存到数据库
- 余额计算正确（存入增加，取出减少）
- 交易记录正确显示

**数据库验证：**
- 在 Supabase 控制台查看 `saving_records` 表，确认数据已保存
- 验证余额计算是否正确（所有存入金额 - 所有取出金额）

### ✅ 7. 课程表模块测试

**测试步骤：**
1. 进入「课程表」页面
2. 查看课程表是否从数据库加载
3. 点击「+」按钮，添加新课程
4. 填写课程信息（名称、地点、教师、时间等）
5. 保存后查看课程是否显示
6. 点击课程卡片，编辑课程
7. 测试导入课表功能（可选）

**预期结果：**
- 课程表正常显示
- 添加课程成功，保存到数据库
- 编辑课程成功，更新数据库
- 课程按时间排序显示

**数据库验证：**
- 在 Supabase 控制台查看 `courses` 表，确认数据已保存

### ✅ 8. 个人资料模块测试

**测试步骤：**
1. 进入「我的」页面
2. 查看个人资料是否从数据库加载
3. 点击头像，更换头像
4. 点击「编辑资料」，修改用户名和简介
5. 保存后查看是否更新

**预期结果：**
- 个人资料正常显示
- 更换头像成功，保存到数据库
- 编辑资料成功，更新数据库
- 首页头像同步更新

**数据库验证：**
- 在 Supabase 控制台查看 `user_profiles` 表，确认数据已保存

## 三、常见问题排查

### 问题1：网络请求失败

**症状：**
- Console 显示网络错误
- 数据无法加载或保存

**排查步骤：**
1. 检查微信小程序后台是否已配置 request 合法域名
2. 检查域名是否正确：`https://mvzpegvtiafzzznzvdqx.supabase.co`
3. 检查 Supabase 项目是否正常运行
4. 检查网络连接是否正常

**解决方法：**
- 在微信开发者工具中，点击「详情」→「本地设置」→ 勾选「不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书」（仅开发环境）

### 问题2：数据库连接失败

**症状：**
- Console 显示 401 或 403 错误
- 数据无法保存

**排查步骤：**
1. 检查 `miniprogram/utils/supabase.ts` 中的 URL 和 KEY 是否正确
2. 检查 Supabase 项目的 API 密钥是否有效
3. 检查数据库表是否已创建
4. 检查 RLS 策略是否正确配置

**解决方法：**
- 确认 Supabase URL 和 anon key 正确
- 在 Supabase 控制台重新执行 `schema.sql` 中的 RLS 策略

### 问题3：数据不显示

**症状：**
- 页面显示正常，但没有数据

**排查步骤：**
1. 检查数据库表中是否有数据
2. 检查 Console 是否有错误信息
3. 检查数据加载函数是否正常执行

**解决方法：**
- 在 Supabase 控制台手动插入测试数据
- 检查数据格式是否正确（JSON 字段格式等）

### 问题4：类型错误

**症状：**
- TypeScript 编译错误
- 类型不匹配

**排查步骤：**
1. 检查 `typings/index.d.ts` 中的类型定义
2. 检查数据库返回的数据格式是否与类型定义匹配

**解决方法：**
- 运行 `npm install` 确保类型定义正确
- 检查数据库字段名是否与代码中的字段名匹配

## 四、调试技巧

### 1. 使用微信开发者工具调试

- **Console 面板**：查看日志和错误信息
- **Network 面板**：查看网络请求和响应
- **Storage 面板**：查看本地存储数据
- **Sources 面板**：设置断点调试

### 2. 使用 Supabase 控制台调试

- **Table Editor**：直接查看和编辑数据库数据
- **SQL Editor**：执行 SQL 查询，验证数据
- **Logs**：查看 API 请求日志
- **API Docs**：查看 API 文档

### 3. 添加调试日志

在关键位置添加 `console.log` 来追踪数据流：

```typescript
// 示例：在加载数据时添加日志
async loadData() {
  console.log('开始加载数据...')
  try {
    const data = await loadMoments()
    console.log('数据加载成功:', data)
    this.setData({ moments: data })
  } catch (error) {
    console.error('数据加载失败:', error)
  }
}
```

## 五、测试数据准备

### 手动插入测试数据（可选）

如果数据库为空，可以在 Supabase Table Editor 中手动插入测试数据：

**示例：插入一条动态**
```sql
INSERT INTO moments (id, avatar, nickname, time, location, content, images, likes, liked_by_me)
VALUES (
  'moment-test-001',
  '../../assets/avatar-a.png',
  '测试用户',
  '12:00',
  '测试地点',
  '这是一条测试动态',
  '[]',
  0,
  false
);
```

**示例：插入一条笔记**
```sql
INSERT INTO notes (id, content, attachments, pinned)
VALUES (
  'note-test-001',
  '这是一条测试笔记',
  '[]',
  false
);
```

## 六、性能测试

### 1. 数据加载速度

- 测试大量数据时的加载速度
- 检查是否有性能瓶颈

### 2. 网络请求优化

- 检查是否有重复请求
- 检查请求是否并行执行

### 3. 内存使用

- 监控小程序内存使用情况
- 检查是否有内存泄漏

## 七、测试完成标准

✅ 所有功能模块正常工作
✅ 数据能正确保存到数据库
✅ 数据能正确从数据库加载
✅ 错误处理正常，用户提示友好
✅ 无控制台错误
✅ 无类型错误
✅ 网络请求正常
✅ 用户体验流畅

## 八、下一步

测试通过后，可以：
1. 优化用户体验
2. 添加更多功能
3. 完善错误处理
4. 添加用户认证（生产环境）
5. 配置更严格的 RLS 策略（生产环境）
6. 准备上线发布

