# 天气功能 403 错误解决方案

## 🔍 问题分析

根据控制台错误信息，天气功能遇到以下问题：

1. **403 Forbidden - Invalid Host**
   - 错误信息：`"An invalid or unauthorized API Host."`
   - 说明：和风天气API拒绝了来自微信小程序的请求

2. **404 Not Found**
   - `geoapi.qweather.com/v2/city/lookup` 返回404
   - 可能是API路径或参数问题

## ✅ 解决方案（按优先级）

### 方案1：配置微信开发者工具本地设置（最快，开发环境）

**这是最快的临时解决方案，适合开发测试：**

1. 在微信开发者工具中，点击右上角 **「详情」** 按钮
2. 切换到 **「本地设置」** 标签页
3. 勾选 **「不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书」**
4. 关闭详情窗口
5. 点击 **「编译」** 按钮重新编译小程序
6. 重新测试天气功能

**注意：** 这只是开发环境的临时方案，正式发布前必须配置合法域名。

---

### 方案2：配置微信小程序 request 合法域名（生产环境必须）

**需要在微信公众平台配置：**

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入你的小程序管理后台
3. 开发 → 开发管理 → 开发设置
4. 找到 **「服务器域名」** → **「request合法域名」**
5. 点击 **「修改」** 按钮
6. 添加以下域名：
   ```
   https://geoapi.qweather.com
   https://devapi.qweather.com
   ```
7. 点击 **「保存」** 按钮
8. 等待10-30分钟让配置生效
9. 重新编译小程序并测试

---

### 方案3：配置和风天气应用限制（如果需要）

虽然你的和风天气控制台显示"应用限制"为"不限制"，但如果仍然出现403错误，可以尝试：

1. 登录 [和风天气控制台](https://console.qweather.com/)
2. 进入你的项目
3. 找到API凭据设置
4. 在 **「应用限制」** 中：
   - 如果选择"网站"，添加微信小程序的域名
   - 或者保持"不限制"（推荐）
5. 保存设置

**注意：** 微信小程序的域名通常是 `servicewechat.com`，但和风天气可能不支持直接配置小程序域名。如果方案1和方案2都配置了，通常不需要在和风天气端配置。

---

## 🔧 验证步骤

配置完成后，按以下步骤验证：

1. **清除缓存并重新编译**
   - 在微信开发者工具中点击 **「编译」** → **「清除缓存」** → **「重新编译」**

2. **检查控制台**
   - 打开调试器 → Console 面板
   - 查看是否还有 403 或 404 错误
   - 应该看到成功的网络请求（状态码 200）

3. **测试天气功能**
   - 打开天气页面
   - 查看是否能正常加载天气数据
   - 测试添加城市功能
   - 测试切换城市功能

---

## 📊 当前配置状态

### API Key 配置 ✅
- 代码中的API Key：`5157c47b70ae4e2ca6517bb8ec621512`
- 和风天气控制台的API Key：`5157c47b70ae4e2ca6517bb8ec621512`
- **状态：** 已正确配置

### 和风天气控制台设置 ✅
- 应用限制：不限制
- API限制：不限制
- **状态：** 已正确配置

### 微信小程序域名配置 ❓
- 需要确认是否已配置 `geoapi.qweather.com` 和 `devapi.qweather.com`
- **建议：** 先使用方案1（本地设置）快速测试，然后配置方案2（合法域名）

---

## ⚠️ 常见问题

### Q1: 配置域名后仍然403错误？
**A:** 
- 等待10-30分钟让配置生效
- 清除小程序缓存并重新编译
- 检查域名格式是否正确（必须包含 `https://`）

### Q2: 开发环境可以，但真机测试不行？
**A:** 
- 真机测试必须配置微信公众平台的合法域名
- 不能使用"不校验合法域名"选项（该选项只在开发者工具中有效）

### Q3: 404错误怎么解决？
**A:** 
- 404错误可能是API路径问题
- 检查代码中的API地址是否正确
- 确认和风天气API文档中的最新路径

---

## 🎯 推荐操作流程

1. **立即操作（开发测试）：**
   - ✅ 使用方案1：在微信开发者工具中勾选"不校验合法域名"
   - ✅ 重新编译并测试天气功能

2. **后续操作（生产环境）：**
   - ✅ 使用方案2：在微信公众平台配置request合法域名
   - ✅ 等待配置生效后，取消勾选"不校验合法域名"
   - ✅ 在真机上测试验证

---

**创建日期：** 2025-01-13  
**问题类型：** 403 Forbidden - Invalid Host  
**相关文件：** `miniprogram/utils/features/weather.ts`, `miniprogram/utils/config.ts`
