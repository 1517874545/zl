# 天气功能修复说明

## ✅ 已完成的修复

### 1. 代码更新

我已经更新了代码，支持配置和风天气的专属API域名：

**修改的文件：**
- `miniprogram/utils/config.ts` - 添加了 `qweatherDomain` 配置项
- `miniprogram/utils/features/weather.ts` - 所有API调用改为使用配置的域名
- `miniprogram/pages/weather/weather.ts` - 定位功能中的API调用也更新了

**默认配置：**
- 当前默认使用：`https://api.qweather.com`
- 如果这个域名不行，需要从和风天气控制台获取专属域名

### 2. 需要你执行的操作

#### 步骤1：测试当前配置

1. **重新编译小程序**
   - 在微信开发者工具中点击「编译」按钮
   - 清除缓存后重新编译

2. **测试天气功能**
   - 打开天气页面
   - 查看控制台是否还有403/404错误
   - 如果 `api.qweather.com` 可以工作，问题就解决了

#### 步骤2：如果仍然403/404错误

如果 `api.qweather.com` 仍然不行，需要获取专属域名：

1. **登录和风天气控制台**
   - 访问：https://console.qweather.com/
   - 进入你的项目（项目ID：`2K85XYGFMK`）

2. **查找专属域名**
   - 在项目设置或API配置中查找
   - 可能的位置：
     - 项目设置 → API配置
     - 凭据管理 → API域名
     - 或者联系技术支持

3. **更新配置**
   - 获取专属域名后（例如：`https://你的域名.qweather.com`）
   - 在 `miniprogram/utils/config.ts` 中更新：
     ```typescript
     qweatherDomain: 'https://你的专属域名.qweather.com',
     ```

4. **配置微信小程序域名**
   - 如果使用新的专属域名，需要在微信小程序后台添加该域名
   - 开发 → 开发管理 → 开发设置 → request合法域名
   - 添加新的专属域名

---

## 📋 当前配置状态

### API Key ✅
- 已正确配置：`5157c47b70ae4e2ca6517bb8ec621512`

### 微信小程序域名 ✅
- 已配置：
  - `https://geoapi.qweather.com`
  - `https://devapi.qweather.com`
  - `https://api.qweather.com`（如果使用默认域名，需要添加）

### 代码配置 ✅
- 已更新为支持专属域名
- 默认尝试使用：`https://api.qweather.com`

---

## 🔍 问题排查

### 如果仍然出现403错误

1. **检查API Key状态**
   - 登录和风天气控制台
   - 确认API Key是否有效
   - 检查是否有使用限制

2. **确认域名配置**
   - 检查代码中的 `qweatherDomain` 是否正确
   - 确认微信小程序后台已配置该域名

3. **联系技术支持**
   - 如果以上都不行，联系和风天气技术支持
   - 邮箱：support@qweather.com
   - 说明：微信小程序调用API返回403 Invalid Host错误

### 如果出现404错误

1. **检查API路径**
   - 确认API版本（v2/v7）是否正确
   - 检查路径格式是否正确

2. **检查参数**
   - 确认location参数格式正确
   - 检查API Key是否正确传递

---

## 🎯 下一步

1. **立即测试**
   - ✅ 重新编译小程序
   - ✅ 测试天气功能
   - ✅ 查看控制台错误

2. **如果不行**
   - ✅ 从和风天气控制台获取专属域名
   - ✅ 更新 `config.ts` 中的域名配置
   - ✅ 在微信小程序后台添加新域名

---

**修复日期：** 2025-01-13  
**修复内容：** 支持专属API域名配置  
**相关文件：** `miniprogram/utils/config.ts`, `miniprogram/utils/features/weather.ts`, `miniprogram/pages/weather/weather.ts`
