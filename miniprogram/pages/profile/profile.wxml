<navigation-bar
  title="我的"
  back="{{false}}"
  color="#1f2d3d"
  background="#ffffff"
></navigation-bar>
<scroll-view class="page-scroll" scroll-y type="list">
  <view class="profile-page">
    <view class="profile-card">
      <!-- 使用微信官方chooseAvatar API -->
      <block wx:if="{{canIUseChooseAvatar}}">
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="profile-avatar" src="{{profile.avatar}}" mode="aspectFill"></image>
          <text class="avatar-tip">点击更换头像</text>
        </button>
      </block>
      
      <!-- 兼容旧版本 -->
      <block wx:else>
        <view class="avatar-wrapper" bindtap="onAvatarAction">
          <image class="profile-avatar" src="{{profile.avatar}}" mode="aspectFill"></image>
          <text class="avatar-tip">点击更换头像</text>
        </view>
      </block>

      <view class="profile-info">
        <text class="profile-name">{{profile.username}}</text>
        <text class="profile-bio">{{profile.bio}}</text>
        <button class="edit-btn" bindtap="onEditProfile">编辑资料</button>
      </view>
    </view>

    <view class="section-card">
      <view class="section-header">
        <text class="section-title">系统设置</text>
        <text class="section-subtitle">自定义通知与权限</text>
      </view>
      <block wx:for="{{settings}}" wx:key="id">
        <view class="setting-row" data-id="{{item.id}}" bindtap="onSettingTap">
          <view class="setting-info">
            <text class="setting-name">{{item.name}}</text>
            <text class="setting-desc">{{item.desc}}</text>
          </view>
          <switch
            wx:if="{{item.type === 'switch'}}"
            checked="{{item.enabled}}"
            color="#FF9F43"
            data-id="{{item.id}}"
            bindchange="onSettingSwitch"
          />
          <text wx:else class="setting-arrow">></text>
        </view>
      </block>
    </view>

    <view class="section-card">
      <view class="section-header">
        <text class="section-title">关于我们</text>
        <text class="section-subtitle">了解更多信息</text>
      </view>
      <view class="setting-row" bindtap="onRateApp">
        <view class="setting-info">
          <text class="setting-name">给好评</text>
          <text class="setting-desc">如果喜欢这款小程序，欢迎给个好评～</text>
        </view>
        <text class="setting-arrow">></text>
      </view>
      <view class="setting-row" bindtap="onViewAbout">
        <view class="setting-info">
          <text class="setting-name">版本信息</text>
          <text class="setting-desc">当前版本 {{appVersion}}</text>
        </view>
        <text class="setting-arrow">></text>
      </view>
    </view>
  </view>
</scroll-view>

<view wx:if="{{showEditModal}}" class="profile-modal-mask" bindtap="onCancelEdit">
  <view class="profile-modal" catchtap="noop">
    <view class="modal-header">
      <text class="modal-title">编辑个人资料</text>
      <text class="modal-close" bindtap="onCancelEdit">✕</text>
    </view>
    <view class="modal-body">
      <view class="modal-row">
        <text class="modal-label">昵称</text>
        <input class="modal-input" value="{{editForm.username}}" data-field="username" bindinput="onEditFormInput" placeholder="请输入昵称" />
      </view>
      <view class="modal-row">
        <text class="modal-label">个性签名</text>
        <textarea class="modal-textarea" value="{{editForm.bio}}" data-field="bio" bindinput="onEditFormInput" placeholder="记录一句喜欢的话"></textarea>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn ghost" bindtap="onCancelEdit">取消</button>
      <button class="modal-btn primary" bindtap="onSaveProfile">保存</button>
    </view>
  </view>
</view>

